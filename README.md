Needs some cleaning up. This is still incomplete
